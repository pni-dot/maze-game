<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Maze Game</title>
    <meta name="viewport" content="width=600, initial-scale=1, user-scalable=no">
    <style>
        body { text-align: center; font-family: sans-serif; }
        .screen { display: none; }
        #gameCanvas { background: #eee; border: 2px solid #333; outline: none; touch-action: manipulation;}
        .avatar { width: 60px; height: 60px; border-radius: 50%; margin: 5px; cursor: pointer;}
        .hidden { display: none; }
        #finalImage { width: 300px; margin: 20px auto 10px auto; display: block;}
        #touchControls button {
            border-radius: 12px;
            margin: 5px;
            background: #f1f3f4;
            border: 2px solid #aaa;
            touch-action: none;
        }
        @media (min-width: 700px) {
            #touchControls { display: none; }
        }
        @media (max-width: 700px) {
            #gameCanvas { width: 98vw; height: 98vw; max-width: 96vw; max-height: 96vw; }
            #finalImage { max-width: 90vw;}
        }
    </style>
</head>
<body>

<!-- Экран 1: Заставка -->
<div id="startScreen" class="screen" style="display: block;">
    <img src="splash.png" alt="Заставка" style="width:400px;max-width:90vw;"><br>
    <button onclick="showPlayerSelect()">Играть</button>
</div>

<!-- Экран 2: Выбор игрока -->
<div id="playerSelectScreen" class="screen">
    <h2>Выберите игрока</h2>
    <div id="avatars"></div>
    <button onclick="backToStart()">Назад</button>
</div>

<!-- Экран 3: Игровой -->
<div id="gameScreen" class="screen">
    <canvas id="gameCanvas" width="600" height="600" tabindex="0"></canvas><br>
    <!-- Кнопки для управления на телефоне -->
    <div id="touchControls" style="margin: 16px 0;">
        <div>
            <button id="btn-up"   style="width:60px; height:60px; font-size:32px;">⬆️</button>
        </div>
        <div>
            <button id="btn-left"  style="width:60px; height:60px; font-size:32px;">⬅️</button>
            <button id="btn-down"  style="width:60px; height:60px; font-size:32px;">⬇️</button>
            <button id="btn-right" style="width:60px; height:60px; font-size:32px;">➡️</button>
        </div>
    </div>
    <div>Время: <span id="timer">120</span> сек</div>
    <button onclick="backToPlayerSelect()">Выйти</button>
</div>

<!-- Экран с вопросом от хранителя -->
<div id="guardianScreen" class="screen">
    <img src="guardian.png" alt="Хранитель" style="width:140px; margin:16px auto; display:block;">
    <h2 style="margin-bottom:0;">Чтобы выйти из лабиринта, ответь на вопрос:</h2>
    <div id="guardianQuestion" style="font-size:1.05em; margin-bottom:18px;">
        ЧТО ОЗНАЧАЕТ СЛОВО НА ГЕРБЕ Nobilitas?
    </div>
    <button onclick="answerGuardian(true)" id="guardianAnswer1" style="margin: 8px 20px; min-width:120px; font-size:1.1em;"></button>
    <button onclick="answerGuardian(false)" id="guardianAnswer2" style="margin: 8px 20px; min-width:120px; font-size:1.1em;"></button>
    <div id="guardianResponse" style="margin-top:20px;font-weight:bold; font-size:1.08em;"></div>
    <div id="guardianContinueDiv" style="margin-top:12px; display:none;">
        <button onclick="continueAfterGuardian()">Продолжить</button>
    </div>
</div>

<!-- Экран 4: Поздравление -->
<div id="resultScreen" class="screen">
    <img id="finalImage" src="" alt="Результат" />
    <h2 id="resultText"></h2>
    <button onclick="restartGame()">Начать заново</button>
</div>

<script>
// =========================
// --- НАСТРОЙКИ ---
const AVATAR_PATHS = [
    'avatar1.png','avatar2.png','avatar3.png','avatar4.png',
    'avatar5.png','avatar6.png','avatar7.png','avatar8.png',
    'avatar9.png','avatar10.png','avatar11.png','avatar12.png'
];
const MAZE_SIZE = 25;
const SUCCESS_IMAGE = 'success.png';
const FAIL_IMAGE = 'fail.png';
const EXIT_COLOR = '#43a047';

const GUARDIAN_QUESTION = "ЧТО ОЗНАЧАЕТ СЛОВО НА ГЕРБЕ Nobilitas?";
const GUARDIAN_ANSWERS = ["Благородство", "Перфекционизм"]; // Первый — правильный
const GUARDIAN_CORRECT_INDEX = 0; // 0 — правильный, 1 — неправильный

let selectedAvatar = AVATAR_PATHS[0];
let maze = [];
let player = {x: 0, y: 0};
let exit = {x: 0, y: 0};
let timer = 120;
let timerId;
let guardian = { x: 0, y: 0, passed: false };

// --- Поиск пути по лабиринту (BFS) ---
function findPath(maze, start, end) {
    let n = maze.length;
    let queue = [start];
    let prev = Array.from({length: n}, () => Array(n).fill(null));
    let visited = Array.from({length: n}, () => Array(n).fill(false));
    visited[start.y][start.x] = true;
    let dirs = [[0,1],[1,0],[0,-1],[-1,0]];

    while (queue.length) {
        let {x, y} = queue.shift();
        if (x === end.x && y === end.y) break;
        for (let [dx,dy] of dirs) {
            let nx = x+dx, ny = y+dy;
            if (nx>=0 && ny>=0 && nx<n && ny<n && !visited[ny][nx] && maze[ny][nx]===0) {
                queue.push({x:nx,y:ny});
                visited[ny][nx]=true;
                prev[ny][nx] = {x, y};
            }
        }
    }
    // Восстановим путь
    let path = [];
    let curr = end;
    while (curr && !(curr.x===start.x && curr.y===start.y)) {
        path.push(curr);
        curr = prev[curr.y][curr.x];
    }
    path.push(start);
    path.reverse();
    return path;
}

// --- Навигация между экранами ---
function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
    document.getElementById(id).style.display = 'block';
}

function showPlayerSelect() { showScreen("playerSelectScreen"); }
function backToStart() { showScreen("startScreen"); }
function selectAvatar(index) { selectedAvatar = AVATAR_PATHS[index]; startGame(); }
function backToPlayerSelect() { clearInterval(timerId); showScreen("playerSelectScreen"); }
function restartGame() { showScreen("startScreen"); }

function renderAvatars() {
    let html = AVATAR_PATHS.map((path, i) =>
        `<img class="avatar" src="${path}" onclick="selectAvatar(${i})">`
    ).join('');
    document.getElementById('avatars').innerHTML = html;
}
renderAvatars();

// --- ИГРА ---
function generateMaze(n) {
    let maze = Array.from({length: n}, () => Array(n).fill(1));
    function carve(x, y) {
        const dirs = [[0,2],[2,0],[0,-2],[-2,0]].sort(()=>Math.random()-0.5);
        maze[y][x] = 0;
        dirs.forEach(([dx,dy])=> {
            let nx = x+dx, ny = y+dy;
            if(nx>=0 && ny>=0 && nx<n && ny<n && maze[ny][nx]==1){
                maze[ y+dy/2 ][ x+dx/2 ]=0;
                carve(nx,ny);
            }
        });
    }
    carve(0,0);
    return maze;
}

function startGame() {
    maze = generateMaze(MAZE_SIZE);
    player = {x: 0, y: 0};
    exit = {x: MAZE_SIZE-1, y: MAZE_SIZE-1};
    // Найти путь и поставить хранителя перед выходом
    let path = findPath(maze, {x:0, y:0}, {x:MAZE_SIZE-1, y:MAZE_SIZE-1});
    let guardianCell = path.length >= 2 ? path[path.length-2] : {x: MAZE_SIZE-2, y: MAZE_SIZE-2};
    guardian = { x: guardianCell.x, y: guardianCell.y, passed: false };
    timer = 120;
    document.getElementById('timer').textContent = timer;
    showScreen("gameScreen");
    setTimeout(() => { document.getElementById('gameCanvas').focus(); }, 100);
    drawGame();
    timerId = setInterval(gameTick, 1000);
}

function gameTick() {
    timer -= 1;
    document.getElementById('timer').textContent = timer;
    if(timer <= 0) return finishGame(false);
}

function drawGame() {
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let size = canvas.width / MAZE_SIZE;
    ctx.fillStyle = "#fff";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    for(let y=0;y<MAZE_SIZE;y++)
      for(let x=0;x<MAZE_SIZE;x++)
        if(maze[y][x]==1){
            ctx.fillStyle = "#333";
            ctx.fillRect(x*size, y*size, size, size);
        }
    // EXIT
    ctx.fillStyle = EXIT_COLOR;
    ctx.fillRect(exit.x*size, exit.y*size, size, size);

    // Рисуем хранителя если не пройден
    if (!guardian.passed) {
        ctx.save();
        ctx.beginPath();
        ctx.arc((guardian.x+0.5)*size, (guardian.y+0.5)*size, size/2.5, 0, 2*Math.PI);
        ctx.closePath();
        ctx.clip();
        let gimg = new Image();
        gimg.src = "guardian.png";
        gimg.onload = function() {
            ctx.drawImage(gimg, guardian.x*size, guardian.y*size, size, size);
            ctx.restore();
        };
        ctx.fillStyle = "#ffcc00";
        ctx.fill();
    }

    // Игрок-аватар
    let img = new Image();
    img.src = selectedAvatar;
    img.onload = ()=>{
        ctx.save();
        ctx.beginPath();
        ctx.arc((player.x+0.5)*size, (player.y+0.5)*size, size/2.1, 0, 2*Math.PI);
        ctx.closePath();
        ctx.clip();
        ctx.drawImage(img, player.x*size, player.y*size, size, size);
        ctx.restore();
    };
}

// -- Управление (клавиатура) --
document.addEventListener("keydown", function(e){
    if (document.getElementById('gameScreen').style.display !== 'block') return;
    let {x, y} = player;
    if(e.key=="ArrowUp" && y>0 && maze[y-1][x]==0) y--;
    if(e.key=="ArrowDown" && y<MAZE_SIZE-1 && maze[y+1][x]==0) y++;
    if(e.key=="ArrowLeft" && x>0 && maze[y][x-1]==0) x--;
    if(e.key=="ArrowRight" && x<MAZE_SIZE-1 && maze[y][x+1]==0) x++;
    // Проверка на хранителя
    if (!guardian.passed && x === guardian.x && y === guardian.y) {
        showGuardianQuestion();
        return;
    }
    if(x!=player.x || y!=player.y) {
        player.x = x; player.y = y;
        drawGame();
        if(x==exit.x && y==exit.y) finishGame(true);
    }
});

// -- Кнопки на телефоне --
function movePlayer(direction) {
    if (document.getElementById('gameScreen').style.display !== 'block') return;
    let {x, y} = player;
    if(direction=="up" && y>0 && maze[y-1][x]==0) y--;
    if(direction=="down" && y<MAZE_SIZE-1 && maze[y+1][x]==0) y++;
    if(direction=="left" && x>0 && maze[y][x-1]==0) x--;
    if(direction=="right" && x<MAZE_SIZE-1 && maze[y][x+1]==0) x++;
    if (!guardian.passed && x === guardian.x && y === guardian.y) {
        showGuardianQuestion();
        return;
    }
    if(x!=player.x || y!=player.y) {
        player.x = x; player.y = y;
        drawGame();
        if(x==exit.x && y==exit.y) finishGame(true);
    }
}

// обработчик удержания
const directions = {
    "btn-up":    "up",
    "btn-down":  "down",
    "btn-left":  "left",
    "btn-right": "right"
};
let holdInterval = null;
function startHold(dir) {
    movePlayer(dir);
    holdInterval = setInterval(() => movePlayer(dir), 80);
}
function stopHold() {
    clearInterval(holdInterval);
}
window.addEventListener('DOMContentLoaded', () => {
    for (const btn in directions) {
        const el = document.getElementById(btn);
        if (!el) continue;
        el.addEventListener("touchstart", e => {
            e.preventDefault();
            startHold(directions[btn]);
        });
        el.addEventListener("touchend", e => {
            e.preventDefault();
            stopHold();
        });
        el.addEventListener("touchcancel", stopHold);
        el.addEventListener("mousedown", () => startHold(directions[btn]));
        el.addEventListener("mouseup", stopHold);
        el.addEventListener("mouseleave", stopHold);
    }
});

// ===== Хранитель =====
function showGuardianQuestion() {
    showScreen('guardianScreen');
    document.getElementById('guardianQuestion').textContent = GUARDIAN_QUESTION;
    document.getElementById('guardianAnswer1').textContent = GUARDIAN_ANSWERS[0];
    document.getElementById('guardianAnswer2').textContent = GUARDIAN_ANSWERS[1];
    document.getElementById('guardianAnswer1').disabled = false;
    document.getElementById('guardianAnswer2').disabled = false;
    document.getElementById('guardianResponse').textContent = "";
    document.getElementById('guardianContinueDiv').style.display = "none";
}

function answerGuardian(isFirst) {
    document.getElementById('guardianAnswer1').disabled = true;
    document.getElementById('guardianAnswer2').disabled = true;

    const correct = (isFirst ? 0 : 1) === GUARDIAN_CORRECT_INDEX;
    if (correct) {
        document.getElementById('guardianResponse').textContent = "Всё верно, проходи!";
        guardian.passed = true;
        document.getElementById('guardianContinueDiv').style.display = "";
    } else {
        document.getElementById('guardianResponse').textContent = "Это не верно, придётся пройти весь путь сначала.";
        document.getElementById('guardianContinueDiv').style.display = "";
        guardian.passed = false;
    }
}

function continueAfterGuardian() {
    if (guardian.passed) {
        showScreen('gameScreen');
        drawGame();
    } else {
        player = {x: 0, y: 0}; // на старт
        showScreen('gameScreen');
        drawGame();
    }
}

// Завершение игры + показ итоговой картинки
function finishGame(win) {
    clearInterval(timerId);
    showScreen('resultScreen');
    let img = document.getElementById('finalImage');
    if(win) {
        document.getElementById('resultText').textContent = "Поздравляем, вы прошли лабиринт!";
        img.src = SUCCESS_IMAGE;
        img.alt = "Вы победили!";
    } else {
        document.getElementById('resultText').textContent = "Время вышло!";
        img.src = FAIL_IMAGE;
        img.alt = "Вы проиграли!";
    }
}
</script>
</body>
</html>
